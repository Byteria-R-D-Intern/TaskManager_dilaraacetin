<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Task Manager – Notifications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/tasks.css" />
  <style>
    .notif-wrap{ display:grid; gap:12px; }
    .section-label{
      font-size:12px; font-weight:700; color:var(--chip-text);
      background:var(--chip); border:1px dashed var(--border);
      padding:6px 10px; border-radius:10px; display:inline-block;
      margin:6px 0 2px;
    }

    .notif{
      display:flex; gap:12px; align-items:flex-start;
      border:1px solid var(--border); background:#fff; border-radius:16px; padding:12px 12px;
      box-shadow: var(--shadow); position:relative; overflow:hidden;
      cursor:pointer; transition: transform .06s ease, border-color .15s ease, background .15s ease;
    }
    .notif:hover{ border-color:var(--ring); background:#fcfdff; }
    .notif:active{ transform: translateY(1px); }

    .notif.unread::before{
      content:""; position:absolute; left:0; top:0; bottom:0; width:5px;
      background:linear-gradient(180deg, var(--primary) 0%, #c7d2fe 100%);
      opacity:.55;
    }

    .n-icon{
      width:42px; height:42px; flex:0 0 42px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border); background:#f9fafc; font-size:18px;
    }
    .n-icon.task{ background:#eef2ff; }
    .n-icon.comment{ background:#fff7ed; }
    .n-icon.user{ background:#ecfdf5; }
    .n-icon.delete{ background:#fff1f2; }

    .n-body{ flex:1; min-width:0; display:grid; gap:4px; }
    .n-title{ font-weight:700; line-height:1.25; }
    .n-text{ color:#374151; line-height:1.35; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .n-by{ color:var(--muted); font-size:12px; } 
    .n-meta{ display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px; flex-wrap:wrap; }
    .n-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px; border-radius:999px; border:1px solid var(--border);
      background:#f8fafc; color:#334155; font-size:12px;
    }
    .n-chip.pri-LOW{ background:var(--green); border-color:#a5e8b0; color:#0f5132; }
    .n-chip.pri-MEDIUM{ background:var(--yellow); border-color:#fbd38d; color:#7c4a03; }
    .n-chip.pri-HIGH{ background:var(--pink); border-color:#f6a8b9; color:#8b1d2c; }

    .n-read{
      margin-left:auto; display:inline-flex; align-items:center; gap:6px;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:#10b981; }
    .dot.unread{ background:#f59e0b; box-shadow:0 0 0 0 rgba(245,158,11,.6); animation:pulse 1.4s infinite; }
    @keyframes pulse{ 0%{box-shadow:0 0 0 0 rgba(245,158,11,.6)} 70%{box-shadow:0 0 0 9px rgba(245,158,11,0)} 100%{box-shadow:0 0 0 0 rgba(245,158,11,0)} }

    .toolbar .group-right{ margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted{ color:var(--muted); }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">Notifications</div>
    <div class="actions">
      <button class="btn" id="refresh-btn">Yenile</button>
      <button class="btn" id="mark-all-read">Hepsini okundu yap</button>
      <button class="btn" id="menu-btn">Menü</button>
      <button class="btn" id="logout-btn">Çıkış</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="toolbar">
        <div class="filters">
          <div class="filter-group">
            <span class="group-title">Arama</span>
            <input type="text" id="search" class="input" placeholder="Ara: başlık / gövde / tür" style="min-width:280px;" />
            <select id="f-priority" class="input" style="width:140px;">
              <option value="">priority: all</option>
              <option value="LOW">LOW</option>
              <option value="MEDIUM">MEDIUM</option>
              <option value="HIGH">HIGH</option>
            </select>
            <select id="f-read" class="input" style="width:140px;">
              <option value="">read: all</option>
              <option value="0">unread</option>
              <option value="1">read</option>
            </select>
          </div>
        </div>

        <div class="group-right">
          <span id="updated" class="small muted"></span>
        </div>
      </div>

      <div id="list" class="notif-wrap"></div>
      <div id="empty" class="empty" style="display:none;">Bildirim yok.</div>
    </section>
  </main>

  <script>
    const API_BASE = "http://localhost:8080/api";
    const token = localStorage.getItem("jwtToken");
    if (!token) { window.location.href = "auth.html"; }

    document.getElementById("menu-btn").addEventListener("click", ()=>location.href="menu.html");
    document.getElementById("logout-btn").addEventListener("click", ()=>{ localStorage.removeItem("jwtToken"); location.href="auth.html"; });
    document.getElementById("refresh-btn").addEventListener("click", fetchNotifications);
    document.getElementById("mark-all-read").addEventListener("click", markAllRead);

    function authFetch(url, options = {}) {
      const headers = options.headers || {};
      return fetch(url, {
        ...options,
        headers: { 
          ...headers, 
          "Authorization": `Bearer ${token}`, 
          ...(options.method && options.method!=="GET" ? {"Content-Type":"application/json"} : {}) 
        }
      }).then(async res=>{
        if (res.status === 401 || res.status === 403) {
          alert("Oturum süresi doldu / yetki yok.");
          localStorage.removeItem("jwtToken");
          location.href="auth.html";
          throw new Error("Unauthorized");
        }
        return res;
      });
    }

    const esc = s => (s==null? "" : String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;"));
    const debounce = (fn,wait=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; };
    const fmtAbs = ts => { try { return ts ? new Date(ts).toLocaleString('tr-TR') : ""; } catch { return ts||""; } };
    function relTime(ts){
      try{
        if (!ts) return "";
        const d = new Date(ts); const now = new Date();
        const diff = (now - d) / 1000; 
        if (diff < 60) return "az önce";
        if (diff < 3600) return Math.floor(diff/60) + " dk önce";
        if (diff < 86400) return Math.floor(diff/3600) + " sa önce";
        const days = Math.floor(diff/86400);
        if (days === 1) return "dün";
        if (days < 7) return days + " gün önce";
        return d.toLocaleDateString('tr-TR');
      }catch{ return ts; }
    }

    function N(x){ return {
      id:            x.id ?? null,
      actorUserId:   x.actorUserId ?? x.actor_user_id ?? null,
      actorUsername: x.actorUsername ?? x.actor_username ?? null,
      targetUserId:  x.targetUserId ?? x.target_user_id ?? null,
      targetUsername:x.targetUsername ?? x.target_username ?? null,
      type:          x.type ?? "",
      title:         x.title ?? "",
      body:          x.body ?? null,
      priority:      x.priority ?? "",
      read:          (typeof x.read === "boolean") ? x.read : (typeof x.is_read !== "undefined" ? !!x.is_read : false),
      readAt:        x.readAt ?? x.read_at ?? null,
      sourceLogId:   x.sourceLogId ?? x.source_log_id ?? null,
      createdAt:     x.createdAt ?? x.created_at ?? x.timestamp ?? null
    };}

    let all = [];
    let timer = null;
    const filters = { q:"", priority:"", read:"" };

    document.getElementById("search").addEventListener("input", debounce(e=>{ filters.q = e.target.value.trim().toLowerCase(); render(); }, 300));
    document.getElementById("f-priority").addEventListener("change", e=>{ filters.priority = e.target.value; render(); });
    document.getElementById("f-read").addEventListener("change", e=>{ filters.read = e.target.value; render(); });

    async function fetchNotifications(){
      try{
        const res = await authFetch(`${API_BASE}/logs/notifications`);
        if (!res.ok) throw new Error(await res.text() || "Bildirimler alınamadı");
        const data = await res.json();
        all = (Array.isArray(data)? data: []).map(N).sort((a,b)=>{
          const ta = a.createdAt || ""; const tb = b.createdAt || "";
          return (tb > ta) ? 1 : (tb < ta ? -1 : 0);
        });
        document.getElementById("updated").textContent = "Güncellendi: " + new Date().toLocaleString();
        render();
      }catch(e){
        console.error(e); alert("Bildirimler alınırken hata oluştu.");
      }
    }

    function getFiltered(){
      let list = all;
      if (filters.q){
        list = list.filter(n=>{
          const hay = `${n.type??""} ${n.title??""} ${n.body??""}`.toLowerCase();
          return hay.includes(filters.q);
        });
      }
      if (filters.priority) list = list.filter(n => (n.priority||"") === filters.priority);
      if (filters.read !== "") list = list.filter(n => (n.read ? "1" : "0") === filters.read);
      return list;
    }

    function groupByDay(list){
      const groups = new Map();
      for (const n of list){
        const d = n.createdAt ? new Date(n.createdAt) : new Date();
        const key = d.toISOString().slice(0,10); 
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(n);
      }
      return Array.from(groups.entries()).sort((a,b)=> (a[0]<b[0]?1:-1));
    }

    function iconFor(n){
      const t = (n.type||"").toUpperCase();
      if (t.startsWith("TASK_")){
        if (t.includes("DELETE")) return {cls:"n-icon task delete", sym:"🗑️"};
        if (t.includes("UPDATE")) return {cls:"n-icon task", sym:"✏️"};
        return {cls:"n-icon task", sym:"🧩"};
      }
      if (t.startsWith("COMMENT_")) return {cls:"n-icon comment", sym:"💬"};
      if (t.startsWith("USER_")) return {cls:"n-icon user", sym:"👤"};
      return {cls:"n-icon", sym:"🔔"};
    }

    function render(){
      const wrap = document.getElementById("list");
      const empty = document.getElementById("empty");
      wrap.innerHTML = "";

      const data = getFiltered();
      if (!data.length){ empty.style.display=""; return; }
      empty.style.display="none";

      const groups = groupByDay(data);
      const todayKey = new Date().toISOString().slice(0,10);
      const yesterdayKey = new Date(Date.now()-86400000).toISOString().slice(0,10);

      for (const [day, items] of groups){
        const label = (day===todayKey) ? "Bugün" : (day===yesterdayKey ? "Dün" : new Date(day).toLocaleDateString('tr-TR'));
        const h = document.createElement("div");
        h.innerHTML = `<span class="section-label">${label}</span>`;
        wrap.appendChild(h);

        for (const n of items){
          const {cls, sym} = iconFor(n);
          const div = document.createElement("div");
          div.className = `notif ${n.read? "" : "unread"}`;
          div.setAttribute("data-id", n.id);

          const byStr = n.actorUsername
            ? `by ${n.actorUsername}`
            : (n.actorUserId != null ? `by #${n.actorUserId}` : "");

          div.innerHTML = `
            <div class="${cls}" aria-hidden="true">${sym}</div>
            <div class="n-body">
              <div class="n-title">${esc(n.title || "(başlık yok)")}</div>
              <div class="n-text">${n.body ? esc(n.body) : ""}</div>
              ${byStr ? `<div class="n-by">${esc(byStr)}</div>` : ""}
              <div class="n-meta">
                <span class="small muted">${esc(n.type || "-")}</span>
                <span class="n-chip pri-${(n.priority||"").toUpperCase()}">${esc(n.priority || "-")}</span>
                <span class="small muted">• ${esc(relTime(n.createdAt))}</span>
                <span class="n-read">
                  <span class="dot ${n.read? "" : "unread"}"></span>
                  <span class="small muted">${n.read ? ("okundu • " + esc(relTime(n.readAt))) : "okunmadı"}</span>
                </span>
              </div>
            </div>
          `;
          div.addEventListener("click", ()=> onNotificationClick(n));
          wrap.appendChild(div);
        }
      }
    }

    async function onNotificationClick(n){
      try {
        await markRead(n);
      } catch(e) {
        console.warn("markRead hata:", e);
      }
      goToNotification(n);
    }

    async function markRead(n){
      if (n.read) return;
      const res = await authFetch(`${API_BASE}/logs/notifications/${encodeURIComponent(n.id)}/read`, { method:"POST" });
      if (!res.ok) throw new Error(await res.text() || "okundu işaretlenemedi");
      n.read = true; n.readAt = new Date().toISOString();
      const el = document.querySelector(`.notif[data-id="${CSS.escape(String(n.id))}"]`);
      if (el){ el.classList.remove("unread"); render(); }
    }

    async function markAllRead(){
      if (!confirm("Tüm bildirimler okundu olarak işaretlensin mi?")) return;
      try{
        const res = await authFetch(`${API_BASE}/logs/notifications/read-all`, { method:"POST" });
        if (!res.ok) throw new Error(await res.text() || "işlem başarısız");
        all = all.map(n => ({ ...n, read:true, readAt: new Date().toISOString() }));
        render();
      }catch(e){ alert("Hata: " + (e.message || "Mark all read")); }
    }


    function parseTarget(n){
      const t = (n.type||"").toUpperCase();
      const resource = (t.split("_")[0] || "").trim(); 
      let id = null;

      const mTitle = (n.title||"").match(/\(ID:\s*(\d+)\)/i);
      if (mTitle) id = Number(mTitle[1]);

      if (!id && n.body && n.body.trim().startsWith("{")){
        try{
          const j = JSON.parse(n.body);
          const keys = ["taskId","task_id","resourceId","resource_id","parentTaskId","parent_task_id","id"];
          for (const k of keys){ if (typeof j[k] === "number"){ id = j[k]; break; } }
        }catch(_){}
      }

      if (!id && n.body){
        const m1 = n.body.match(/task\s*id[\s:#]*?(\d+)/i);
        const m2 = n.body.match(/task\s*[#\(]?\s*(\d+)/i);
        const m3 = n.body.match(/\bID[:\s]*?(\d+)\b/i);
        const m = m1 || m2 || m3;
        if (m) id = Number(m[1]);
      }

      return { resource, id };
    }

    function goToNotification(n){
      const { resource, id } = parseTarget(n);
      const openComments = (resource === "COMMENT");

      if (resource === "TASK" || openComments){
        const q = id ? `?taskId=${encodeURIComponent(id)}${openComments ? "&open=comments" : ""}` : "";
        window.location.href = `my-tasks.html${q}`;
      }
    }

    function startPolling(){
      if (timer) clearInterval(timer);
      timer = setInterval(fetchNotifications, 5000);
    }
    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden) { if (timer){ clearInterval(timer); timer = null; } }
      else { fetchNotifications(); startPolling(); }
    });

    fetchNotifications();
    startPolling();
  </script>
</body>
</html>
