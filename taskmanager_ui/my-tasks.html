<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Task Manager – My Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/tasks.css" />
</head>
<body>
  <header class="appbar">
    <div class="brand">My Tasks</div>
    <div class="actions">
      <button class="btn" id="menu-btn">Menü</button>
      <button class="btn" id="refresh-btn">Yenile</button>
      <button class="btn" id="logout-btn">Çıkış</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="toolbar">
        <div class="filters">
          <div class="filter-group">
            <span class="group-title">Status</span>
            <div class="chips" id="chip-status">
              <button class="chip active" data-status="">All</button>
              <button class="chip" data-status="TODO">To Do</button>
              <button class="chip" data-status="IN_PROGRESS">In Progress</button>
              <button class="chip" data-status="DONE">Done</button>
            </div>
          </div>

          <div class="filter-group">
            <span class="group-title">Priority</span>
            <div class="chips" id="chip-priority">
              <button class="chip active" data-priority="">All</button>
              <button class="chip" data-priority="LOW">Low</button>
              <button class="chip" data-priority="MEDIUM">Medium</button>
              <button class="chip" data-priority="HIGH">High</button>
            </div>
          </div>
        </div>

        <div class="search">
          <input id="search-input" class="input" type="text" placeholder="Başlığa göre ara…" />
          <button id="clear-filters" class="btn">Temizle</button>
        </div>
      </div>

      <ul id="task-list" class="tasks"></ul>
      <div id="empty" class="empty" style="display:none;">Görev bulunamadı.</div>
    </section>
  </main>

  <script>
    const API_BASE = "http://localhost:8080/api";
    const token = localStorage.getItem("jwtToken");
    if (!token) { window.location.href = "auth.html"; }

    document.getElementById("menu-btn").addEventListener("click", ()=> location.href="menu.html");
    document.getElementById("logout-btn").addEventListener("click", ()=>{ localStorage.removeItem("jwtToken"); location.href="auth.html"; });
    document.getElementById("refresh-btn").addEventListener("click", loadTasks);

    async function authFetch(url, options = {}) {
      const headers = options.headers || {};
      const res = await fetch(url, {
        ...options,
        headers: {
          ...headers,
          "Authorization": `Bearer ${token}`,
          ...(options.method && options.method !== "GET" ? { "Content-Type": "application/json" } : {})
        }
      });
      if (res.status === 401 || res.status === 403) {
        alert("Oturum süreniz doldu. Lütfen tekrar giriş yapın.");
        localStorage.removeItem("jwtToken");
        window.location.href = "auth.html";
        throw new Error("Unauthorized");
      }
      return res;
    }

    const filters = { status:"", priority:"", title:"" };

    function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
    function escapeHtml(str){ if(!str) return ""; return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }

    async function loadTasks(){
      try{
        const params = new URLSearchParams();
        if (filters.status) params.append("status", filters.status);
        if (filters.priority) params.append("priority", filters.priority);
        if (filters.title) params.append("title", filters.title);

        const url = params.toString()? `${API_BASE}/tasks?${params}` : `${API_BASE}/tasks`;
        const res = await authFetch(url);
        if (!res.ok) throw new Error(await res.text() || "Görevler yüklenemedi");
        const tasks = await res.json();
        render(tasks);
      }catch(e){
        console.error(e); alert("Görevler alınırken hata oluştu.");
      }
    }

    function render(tasks){
      const list = document.getElementById("task-list");
      const empty = document.getElementById("empty");
      list.innerHTML = "";
      empty.style.display = (!Array.isArray(tasks) || tasks.length===0) ? "" : "none";
      if (!Array.isArray(tasks) || tasks.length===0) return;

      for (const t of tasks){
        const li = document.createElement("li");
        li.className = `task status-${t.status}`;
        li.setAttribute("data-id", String(t.id));          // <<< eklendi
        li.innerHTML = `
          <div class="row">
            <div class="title">${escapeHtml(t.title)}</div>
            <div class="actions">
              <button class="btn danger btn-del" data-id="${t.id}">Sil</button>
            </div>
          </div>
          <div class="desc">${escapeHtml(t.description || "")}</div>
          <div class="row">
            <div class="meta">
              <span class="badge ${t.status==='TODO'?'status-todo':t.status==='IN_PROGRESS'?'status-inprogress':'status-done'}">${t.status.replace('_',' ')}</span>
              <span class="badge ${t.priority==='LOW'?'pri-low':t.priority==='MEDIUM'?'pri-medium':'pri-high'}">Priority: ${t.priority}</span>
              ${t.dueDate ? `<span class="badge">Due: ${t.dueDate}</span>` : ""}
            </div>
            <span class="small muted right">@${escapeHtml(t.username || 'Me')}</span>
          </div>
        `;
        list.appendChild(li);
      }

      try{
        const params = new URLSearchParams(location.search);
        const targetId = params.get("taskId");
        if (targetId){
          const el = document.querySelector(`li.task[data-id="${CSS.escape(targetId)}"]`);
          if (el){
            el.scrollIntoView({ behavior:"smooth", block:"center" });
            el.style.boxShadow = "0 0 0 3px rgba(141,165,248,.35), var(--shadow)";
            el.style.transition = "box-shadow .3s ease, background .3s ease";
            el.style.background = "#fcfdff";
            setTimeout(()=>{
              el.style.boxShadow = "var(--shadow)";
              el.style.background = "#fff";
            }, 2200);
          }
        }
      }catch(_){}
    }

    document.getElementById("task-list").addEventListener("click", async (e)=>{
      const btn = e.target.closest(".btn-del");
      if (!btn) return;
      const id = btn.dataset.id;
      if (!confirm(`#${id} numaralı görevi silmek istiyor musun?`)) return;
      try{
        const res = await authFetch(`${API_BASE}/tasks/${encodeURIComponent(id)}`, { method:"DELETE" });
        if (res.status === 204){ loadTasks(); }
        else { alert(await res.text() || "Silinemedi"); }
      }catch(err){ alert("Hata: " + (err.message || "silme")); }
    });

    document.getElementById("chip-status").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-status]");
      if (!btn) return;
      filters.status = btn.getAttribute("data-status") || "";
      [...e.currentTarget.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
      btn.classList.add("active");
      loadTasks();
    });
    document.getElementById("chip-priority").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-priority]");
      if (!btn) return;
      filters.priority = btn.getAttribute("data-priority") || "";
      [...e.currentTarget.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
      btn.classList.add("active");
      loadTasks();
    });

    const searchEl = document.getElementById("search-input");
    searchEl.addEventListener("input", debounce(()=>{ filters.title = searchEl.value.trim(); loadTasks(); }, 300));
    searchEl.addEventListener("keypress", (e)=>{ if (e.key === "Enter") e.preventDefault(); });

    document.getElementById("clear-filters").addEventListener("click", ()=>{
      filters.status = ""; filters.priority = ""; filters.title = "";
      document.querySelectorAll("#chip-status .chip, #chip-priority .chip").forEach((c,i)=>{
        c.classList.toggle("active", c.dataset.status==="" || c.dataset.priority==="");
      });
      searchEl.value = "";
      loadTasks();
    });

    loadTasks();
  </script>
</body>
</html>
