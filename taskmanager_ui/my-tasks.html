<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Task Manager – My Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/tasks.css" />
  <style>
    .modal-mask{ position:fixed; inset:0; background:rgba(0,0,0,.28); opacity:0; pointer-events:none; transition:opacity .18s ease; z-index:60; }
    .modal{ display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:70; }
    .modal.open{ display:flex; }
    .modal-mask.show{ opacity:1; pointer-events:auto; }
    .modal-card{ width:620px; max-width:92vw; background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; }
    .mc-head{ padding:12px 14px; border-bottom:1px dashed var(--border); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .mc-body{ padding:12px 14px; display:grid; gap:10px; }
    .mc-foot{ padding:12px 14px; border-top:1px dashed var(--border); display:flex; gap:8px; justify-content:flex-end; }
    .two{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:640px){ .two{ grid-template-columns:1fr 1fr; } }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">My Tasks</div>
    <div class="actions">
      <button class="btn" id="menu-btn">Menü</button>
      <button class="btn" id="refresh-btn">Yenile</button>
      <button class="btn" id="logout-btn">Çıkış</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="toolbar">
        <div class="filters">
          <div class="filter-group">
            <span class="group-title">Status</span>
            <div class="chips" id="chip-status">
              <button class="chip active" data-status="">All</button>
              <button class="chip" data-status="TODO">To Do</button>
              <button class="chip" data-status="IN_PROGRESS">In Progress</button>
              <button class="chip" data-status="DONE">Done</button>
            </div>
          </div>

          <div class="filter-group">
            <span class="group-title">Priority</span>
            <div class="chips" id="chip-priority">
              <button class="chip active" data-priority="">All</button>
              <button class="chip" data-priority="LOW">Low</button>
              <button class="chip" data-priority="MEDIUM">Medium</button>
              <button class="chip" data-priority="HIGH">High</button>
            </div>
          </div>
        </div>

        <div class="search">
          <input id="search-input" class="input" type="text" placeholder="Başlığa göre ara…" />
          <button id="clear-filters" class="btn">Temizle</button>
        </div>
      </div>

      <ul id="task-list" class="tasks"></ul>
      <div id="empty" class="empty" style="display:none;">Görev bulunamadı.</div>
    </section>
  </main>

  <div id="em-mask" class="modal-mask"></div>
  <div id="em" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="em-title">
      <div class="mc-head">
        <div id="em-title" class="brand" style="font-weight:700;">Görevi Düzenle</div>
        <button id="em-close" class="btn">Kapat</button>
      </div>
      <div class="mc-body">
        <input id="em-title-input" class="input" placeholder="Başlık" />
        <textarea id="em-desc-input" class="input" rows="4" placeholder="Açıklama"></textarea>
        <div class="two">
          <select id="em-status" class="input">
            <option value="TODO">To Do</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="DONE">Done</option>
          </select>
          <select id="em-priority" class="input">
            <option value="LOW">Low</option>
            <option value="MEDIUM">Medium</option>
            <option value="HIGH">High</option>
          </select>
        </div>
        <input id="em-due" type="date" class="input" placeholder="gg.aa.yyyy" />
      </div>
      <div class="mc-foot">
        <button id="em-cancel" class="btn">İptal</button>
        <button id="em-save" class="btn primary">Kaydet</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8080/api";
    const token = localStorage.getItem("jwtToken");
    if (!token) { window.location.href = "auth.html"; }

    const params = new URLSearchParams(location.search);
    const initialTaskId = Number(params.get("taskId")) || null;
    const initialOpen = (params.get("open") || "").toLowerCase();
    let shouldOpenComments = !!(initialTaskId && initialOpen === "comments");

    document.getElementById("menu-btn").addEventListener("click", ()=> location.href="menu.html");
    document.getElementById("logout-btn").addEventListener("click", ()=>{ localStorage.removeItem("jwtToken"); location.href="auth.html"; });
    document.getElementById("refresh-btn").addEventListener("click", loadTasks);

    async function authFetch(url, options = {}) {
      const headers = options.headers || {};
      const res = await fetch(url, {
        ...options,
        headers: { ...headers, "Authorization": `Bearer ${token}`, ...(options.method && options.method !== "GET" ? {"Content-Type":"application/json"} : {}) }
      });
      if (res.status === 401 || res.status === 403) {
        alert("Oturum süresi doldu. Lütfen tekrar giriş yapın.");
        localStorage.removeItem("jwtToken");
        window.location.href = "auth.html";
        throw new Error("Unauthorized");
      }
      return res;
    }

    const filters = { status:"", priority:"", title:"" };
    const debounce = (fn,wait=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; };
    const esc = s => (s==null? "" : String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"));

    let tasksCache = [];

    async function loadTasks(){
      try{
        const params = new URLSearchParams();
        if (filters.status) params.append("status", filters.status);
        if (filters.priority) params.append("priority", filters.priority);
        if (filters.title) params.append("title", filters.title);

        const url = params.toString()? `${API_BASE}/tasks?${params}` : `${API_BASE}/tasks`;
        const res = await authFetch(url);
        if (!res.ok) throw new Error(await res.text() || "Görevler yüklenemedi");
        const tasks = await res.json();
        tasksCache = tasks;
        render(tasks);

        if (shouldOpenComments) {
          const t = tasksCache.find(x => Number(x.id) === Number(initialTaskId));
          if (t && window.openCommentsDrawer) {
            window.openCommentsDrawer(t.id, t.title || "");
            shouldOpenComments = false; 
          }
        }
      }catch(e){
        console.error(e); alert("Görevler alınırken hata oluştu.");
      }
    }

    function render(tasks){
      const list = document.getElementById("task-list");
      const empty = document.getElementById("empty");
      list.innerHTML = "";
      empty.style.display = (!Array.isArray(tasks) || tasks.length===0) ? "" : "none";
      if (!Array.isArray(tasks) || tasks.length===0) return;

      for (const t of tasks){
        const li = document.createElement("li");
        li.className = `task status-${t.status}`;
        li.dataset.id = t.id;
        li.innerHTML = `
          <div class="row">
            <div class="title">${esc(t.title)}</div>
            <div class="actions">
              <button class="btn ghost btn-comments" data-id="${t.id}" data-title="${esc(t.title)}">Yorumlar</button>
              <button class="btn btn-edit" data-id="${t.id}">Düzenle</button>
              <button class="btn danger btn-del" data-id="${t.id}">Sil</button>
            </div>
          </div>
          <div class="desc">${esc(t.description || "")}</div>
          <div class="row">
            <div class="meta">
              <span class="badge ${t.status==='TODO'?'status-todo':t.status==='IN_PROGRESS'?'status-inprogress':'status-done'}">${t.status.replace('_',' ')}</span>
              <span class="badge ${t.priority==='LOW'?'pri-low':t.priority==='MEDIUM'?'pri-medium':'pri-high'}">Priority: ${t.priority}</span>
              ${t.dueDate ? `<span class="badge">Due: ${t.dueDate}</span>` : ""}
            </div>
            <span class="small muted right">@${esc(t.username || 'Me')}</span>
          </div>
        `;
        list.appendChild(li);
      }
    }

    document.getElementById("task-list").addEventListener("click", async (e)=>{
      const cm = e.target.closest(".btn-comments");
      const edt = e.target.closest(".btn-edit");
      const del = e.target.closest(".btn-del");

      if (cm){
        const id = Number(cm.dataset.id);
        const title = cm.dataset.title || "";
        window.openCommentsDrawer?.(id, title);
        return;
      }
      if (edt){
        const id = Number(edt.dataset.id);
        const t = tasksCache.find(x=>Number(x.id)===id);
        if (t) openEdit(t);
        return;
      }
      if (del){
        const id = e.target.dataset.id;
        if (!confirm(`#${id} numaralı görevi silmek istiyor musun?`)) return;
        try{
          const res = await authFetch(`${API_BASE}/tasks/${encodeURIComponent(id)}`, { method:"DELETE" });
          if (res.status === 204){ loadTasks(); }
          else { alert(await res.text() || "Silinemedi"); }
        }catch(err){ alert("Hata: " + (err.message || "silme")); }
      }
    });

    document.getElementById("chip-status").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-status]");
      if (!btn) return;
      filters.status = btn.getAttribute("data-status") || "";
      [...e.currentTarget.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
      btn.classList.add("active");
      loadTasks();
    });
    document.getElementById("chip-priority").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-priority]");
      if (!btn) return;
      filters.priority = btn.getAttribute("data-priority") || "";
      [...e.currentTarget.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
      btn.classList.add("active");
      loadTasks();
    });

    const searchEl = document.getElementById("search-input");
    searchEl.addEventListener("input", debounce(()=>{ filters.title = searchEl.value.trim(); loadTasks(); }, 300));
    searchEl.addEventListener("keypress", (e)=>{ if (e.key === "Enter") e.preventDefault(); });
    document.getElementById("clear-filters").addEventListener("click", ()=>{
      filters.status = ""; filters.priority = ""; filters.title = "";
      document.querySelectorAll("#chip-status .chip, #chip-priority .chip").forEach((c,i)=>{
        c.classList.toggle("active", c.dataset.status==="" || c.dataset.priority==="");
      });
      searchEl.value = "";
      loadTasks();
    });

    const em = document.getElementById("em");
    const emMask = document.getElementById("em-mask");
    const emClose = document.getElementById("em-close");
    const emCancel = document.getElementById("em-cancel");
    const emSave = document.getElementById("em-save");
    const fTitle = document.getElementById("em-title-input");
    const fDesc = document.getElementById("em-desc-input");
    const fStatus = document.getElementById("em-status");
    const fPriority = document.getElementById("em-priority");
    const fDue = document.getElementById("em-due");
    let editingId = null;

    function openEdit(t){
      editingId = t.id;
      fTitle.value = t.title || "";
      fDesc.value = t.description || "";
      fStatus.value = t.status || "TODO";
      fPriority.value = t.priority || "LOW";
      fDue.value = (t.dueDate || "").substring(0,10);
      em.classList.add("open");
      emMask.classList.add("show");
    }
    function hideEdit(){
      editingId = null;
      em.classList.remove("open");
      emMask.classList.remove("show");
    }
    emMask.addEventListener("click", hideEdit);
    emClose.addEventListener("click", hideEdit);
    emCancel.addEventListener("click", hideEdit);
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') hideEdit(); });
    hideEdit(); 

    emSave.addEventListener("click", async ()=>{
      if (!editingId) return;
      const payload = {
        title: fTitle.value.trim(),
        description: fDesc.value.trim(),
        status: fStatus.value,
        priority: fPriority.value,
        dueDate: fDue.value || null
      };
      try{
        const res = await authFetch(`${API_BASE}/tasks/${encodeURIComponent(editingId)}`, {
          method:"PUT", body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text() || "Güncellenemedi");
        hideEdit();
        await loadTasks();
      }catch(e){
        alert("Hata: " + (e.message || "güncelleme"));
      }
    });

    loadTasks();
  </script>

  <script src="js/comments.js"></script>
</body>
</html>
