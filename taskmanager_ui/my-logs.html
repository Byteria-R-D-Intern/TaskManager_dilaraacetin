<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Task Manager – My Logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/tasks.css" />
  <style>
    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--border); border-radius:14px; overflow:hidden; }
    thead th{ text-align:left; font-weight:600; font-size:14px; padding:12px; background:#f6f8ff; border-bottom:1px solid var(--border); white-space:nowrap; }
    tbody td{ padding:12px; border-bottom:1px solid var(--border); font-size:14px; vertical-align:top; }
    tbody tr:hover{ background:#fafcff; }
    .col-id{ width:84px; }
    .col-action{ width:160px; white-space:nowrap; }
    .col-resource{ width:180px; white-space:nowrap; }
    .muted{ color:var(--muted); }
    .summary{ color:var(--muted); font-size:13px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .nowrap{ white-space:nowrap; }
    .json{ max-width:420px; max-height:60px; overflow:auto; background:#fbfbff; border:1px dashed var(--border); border-radius:8px; padding:6px 8px; }
    .btn.toggle{ background:#fff; border:1px solid var(--border); }
    .btn.toggle.active{ background:var(--primary); color:#fff; border-color:var(--primary); }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">My Logs</div>
    <div class="actions">
      <button class="btn" id="refresh-btn">Yenile</button>
      <button class="btn" id="menu-btn">Menü</button>
      <button class="btn" id="logout-btn">Çıkış</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="toolbar">
        <div class="filters">
          <div class="filter-group">
            <span class="group-title">Quick Range</span>
            <div id="range-buttons">
              <button class="btn toggle" data-limit="10">Last 10</button>
              <button class="btn toggle active" data-limit="30">Last 30</button>
              <button class="btn toggle" data-limit="50">Last 50</button>
              <button class="btn toggle" data-limit="100">Last 100</button>
              <button class="btn" id="clear-range" title="Tümünü göster">Clear</button>
            </div>
          </div>

          <div class="filter-group">
            <span class="group-title">Search</span>
            <input type="text" id="search" class="input" placeholder="Ara: action / resource / resourceId" style="min-width:280px;" />
          </div>

          <div class="filter-group">
            <span class="group-title">Fields</span>
            <input type="text" id="f-action" class="input" placeholder="action" style="width:160px;" />
            <input type="text" id="f-resource" class="input" placeholder="resourceType" style="width:180px;" />
          </div>
        </div>

        <div class="filter-group">
          <span class="group-title">Paging</span>
          <div>
            <button class="btn" id="prev">&larr; Prev</button>
            <span id="page-label" class="summary">Page 1 / 1</span>
            <button class="btn" id="next">Next &rarr;</button>
            <select id="page-size" class="input" style="width:120px;">
              <option value="10">10 / page</option>
              <option value="25" selected>25 / page</option>
              <option value="50">50 / page</option>
              <option value="100">100 / page</option>
            </select>
          </div>
        </div>
      </div>

      <div class="summary" id="updated" style="margin:6px 0 12px;"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="col-id">ID</th>
              <th class="col-action">Action</th>
              <th class="col-resource">Resource</th>
              <th>Resource ID</th>
              <th>Details</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody id="logs-tbody"></tbody>
        </table>
      </div>

      <div id="empty" class="empty" style="display:none;">Kayıt bulunamadı.</div>
    </section>
  </main>

  <script>
    const API_BASE = "http://localhost:8080/api";
    const token = localStorage.getItem("jwtToken");
    if (!token) location.href = "auth.html";

    document.getElementById("menu-btn").addEventListener("click", ()=>location.href="menu.html");
    document.getElementById("logout-btn").addEventListener("click", ()=>{ localStorage.removeItem("jwtToken"); location.href="auth.html"; });
    document.getElementById("refresh-btn").addEventListener("click", fetchLogs);

    function authFetch(url, options = {}) {
      const headers = options.headers || {};
      return fetch(url, {
        ...options,
        headers: { ...headers, "Authorization": `Bearer ${token}`, ...(options.method && options.method!=="GET" ? {"Content-Type":"application/json"} : {}) }
      }).then(async res=>{
        if (res.status === 401 || res.status === 403) {
          alert("Oturum süresi doldu / yetki yok."); localStorage.removeItem("jwtToken"); location.href="auth.html"; throw new Error("Unauthorized");
        }
        return res;
      });
    }
    const debounce = (fn,wait=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; };
    const fmt = ts => { try { return new Date(ts).toLocaleString('tr-TR'); } catch { return ts; } };
    const esc = s => (s==null? "" : String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"));

    function normalizeLog(l){
      return {
        id: l.id ?? null,
        action: l.action ?? l.action_type ?? l.actionType ?? "",
        resourceType: l.resource ?? l.resource_type ?? l.resourceType ?? "",
        resourceId: l.resourceId ?? l.resource_id ?? null,
        details: (typeof l.details === "string" ? l.details : (l.details ? JSON.stringify(l.details) : null)),
        timestamp: l.timestamp ?? l.created_at ?? l.createdAt ?? null
      };
    }

    let allLogs = [];
    let page = 1, pageSize = 25;
    let currentLimit = 30;
    let textSearch = "";
    const fieldFilters = { action:"", resource:"" };

    document.getElementById("range-buttons").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-limit]");
      if (!btn) return;
      currentLimit = parseInt(btn.dataset.limit,10);
      document.querySelectorAll("#range-buttons .toggle").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active"); page=1; render();
    });
    document.getElementById("clear-range").addEventListener("click", ()=>{
      currentLimit = null;
      document.querySelectorAll("#range-buttons .toggle").forEach(b=>b.classList.remove("active"));
      page=1; render();
    });

    document.getElementById("search").addEventListener("input", debounce(e=>{ textSearch = e.target.value.trim().toLowerCase(); page=1; render(); }, 250));
    document.getElementById("f-action").addEventListener("input", debounce(e=>{ fieldFilters.action = e.target.value.trim(); page=1; render(); }, 250));
    document.getElementById("f-resource").addEventListener("input", debounce(e=>{ fieldFilters.resource = e.target.value.trim(); page=1; render(); }, 250));

    document.getElementById("prev").addEventListener("click", ()=>{ if (page>1){ page--; render(); }});
    document.getElementById("next").addEventListener("click", ()=>{ const total = getFiltered().length; const pages = Math.max(1, Math.ceil(total/pageSize)); if (page<pages){ page++; render(); }});
    document.getElementById("page-size").addEventListener("change", (e)=>{ pageSize = parseInt(e.target.value,10); page=1; render(); });

    async function fetchLogs(){
      try{
        const res = await authFetch(`${API_BASE}/logs/me`);
        if (!res.ok) throw new Error(await res.text() || "Loglar alınamadı");
        const data = await res.json();
        allLogs = (Array.isArray(data)? data: []).map(normalizeLog).sort((a,b)=>{
          const ta = a.timestamp || ""; const tb = b.timestamp || "";
          return (tb > ta) ? 1 : (tb < ta ? -1 : 0);
        });
        page = 1;
        document.getElementById("updated").textContent = "Güncellendi: " + new Date().toLocaleString();
        render();
      }catch(e){
        console.error(e); alert("Loglar alınırken hata oluştu.");
      }
    }

    function getFiltered(){
      let list = allLogs;
      if (textSearch){
        list = list.filter(l=>{
          const hay = `${l.id??""} ${l.action??""} ${l.resourceType??""} ${l.resourceId??""}`.toLowerCase();
          return hay.includes(textSearch);
        });
      }
      if (fieldFilters.action)   list = list.filter(l => (l.action||"").toLowerCase().includes(fieldFilters.action.toLowerCase()));
      if (fieldFilters.resource) list = list.filter(l => (l.resourceType||"").toLowerCase().includes(fieldFilters.resource.toLowerCase()));
      if (currentLimit != null)  list = list.slice(0, currentLimit);
      return list;
    }

    function render(){
      const tbody = document.getElementById("logs-tbody");
      const empty = document.getElementById("empty");
      tbody.innerHTML = "";

      const data = getFiltered();
      if (!data.length){
        empty.style.display = "";
        document.getElementById("page-label").textContent = "Page 1 / 1";
        return;
      }
      empty.style.display = "none";

      const pages = Math.max(1, Math.ceil(data.length / pageSize));
      if (page > pages) page = pages;
      const start = (page-1)*pageSize;
      const end = start + pageSize;

      for (const log of data.slice(start,end)){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="nowrap mono">#${esc(log.id)}</td>
          <td class="nowrap">${esc(log.action || "-")}</td>
          <td class="nowrap">${esc(log.resourceType || "-")}</td>
          <td class="nowrap mono">${esc(log.resourceId ?? "-")}</td>
          <td>${log.details ? `<div class="json mono">${esc(log.details)}</div>` : `<span class="muted">—</span>`}</td>
          <td class="nowrap"><span class="muted">${esc(fmt(log.timestamp ?? ""))}</span></td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById("page-label").textContent = `Page ${page} / ${pages}`;
    }

    // İsteğe bağlı canlılık: 5 sn'de bir yenile
    let timer = null;
    function startPolling(){ if (timer) clearInterval(timer); timer = setInterval(fetchLogs, 5000); }
    fetchLogs();
    startPolling();
  </script>
</body>
</html>
