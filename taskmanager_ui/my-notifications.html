<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Task Manager – My Notifications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/tasks.css" />
  <style>
    .ntf-list{ display:grid; gap:12px; }
    .ntf{
      background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px;
      display:grid; gap:8px; position:relative;
    }
    .ntf.unread{ border-color:#cdd7ff; box-shadow:0 6px 16px rgba(141,165,248,.12); }
    .ntf .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .ntf .meta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:12px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#f7f7ff; font-size:12px; }
    .pri-LOW{ background:#eaf9ef; border-color:#cfeeda; }
    .pri-NORMAL{ background:#eef2ff; border-color:#dbeafe; }
    .pri-HIGH{ background:#fff2f2; border-color:#ffd6d6; }
    .empty{ text-align:center; color:var(--muted); padding:24px; border:1px dashed var(--border); border-radius:14px; background:#fff; }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">My Notifications</div>
    <div class="actions">
      <button class="btn" id="menu-btn">Menü</button>
      <button class="btn" id="refresh-btn">Yenile</button>
      <button class="btn" id="mark-all-btn">Tümünü Okundu Yap</button>
      <button class="btn" id="logout-btn">Çıkış</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="toolbar">
        <div class="filters">
          <div class="filter-group">
            <span class="group-title">Durum</span>
            <div class="chips" id="chip-read">
              <button class="chip active" data-read="">All</button>
              <button class="chip" data-read="0">Unread</button>
              <button class="chip" data-read="1">Read</button>
            </div>
          </div>
          <div class="filter-group">
            <span class="group-title">Tip</span>
            <input type="text" id="f-type" class="input" placeholder="type (örn: TASK_UPDATED)" style="width:200px;" />
          </div>
          <div class="filter-group">
            <span class="group-title">Ara</span>
            <input type="text" id="f-q" class="input" placeholder="başlık/içerik içinde ara…" style="min-width:260px;" />
          </div>
        </div>
      </div>

      <div id="updated" class="small muted" style="margin:6px 0 12px;"></div>

      <div id="list" class="ntf-list"></div>
      <div id="empty" class="empty" style="display:none;">Bildirim yok.</div>
    </section>
  </main>

  <script>
    const API_BASE = "http://localhost:8080/api";
    const token = localStorage.getItem("jwtToken");
    if (!token) { location.href = "auth.html"; }

    document.getElementById("menu-btn").addEventListener("click", ()=>location.href="menu.html");
    document.getElementById("logout-btn").addEventListener("click", ()=>{ localStorage.removeItem("jwtToken"); location.href="auth.html"; });
    document.getElementById("refresh-btn").addEventListener("click", loadNotifications);

    function authFetch(url, options = {}) {
      const headers = options.headers || {};
      return fetch(url, {
        ...options,
        headers: { ...headers, "Authorization": `Bearer ${token}`, ...(options.method && options.method!=="GET" ? {"Content-Type":"application/json"} : {}) }
      }).then(async res=>{
        if (res.status === 401 || res.status === 403) {
          alert("Oturum süresi doldu / yetki yok."); localStorage.removeItem("jwtToken"); location.href="auth.html"; throw new Error("Unauthorized");
        }
        return res;
      });
    }
    const debounce = (fn,wait=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; };
    const esc = s => (s==null? "" : String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"));
    const fmt = ts => { try { return new Date(ts).toLocaleString('tr-TR'); } catch { return ts; } };

    const filters = { read:"", type:"", q:"" };
    document.getElementById("chip-read").addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-read]");
      if (!btn) return;
      filters.read = btn.getAttribute("data-read");
      [...e.currentTarget.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
      btn.classList.add("active");
      render();
    });
    document.getElementById("f-type").addEventListener("input", debounce(e=>{ filters.type = e.target.value.trim(); render(); }, 250));
    document.getElementById("f-q").addEventListener("input", debounce(e=>{ filters.q = e.target.value.trim().toLowerCase(); render(); }, 250));

    let all = [];

    async function loadNotifications(){
      try{
        const res = await authFetch(`${API_BASE}/notifications`);
        if (!res.ok) throw new Error(await res.text() || "Bildirimler alınamadı");
        const data = await res.json();
        all = (Array.isArray(data)? data: []).slice().sort((a,b)=>{
          const ta = a.created_at || a.createdAt || ""; const tb = b.created_at || b.createdAt || "";
          return (tb > ta) ? 1 : (tb < ta ? -1 : 0);
        });
        document.getElementById("updated").textContent = "Güncellendi: " + new Date().toLocaleString();
        render();
      }catch(e){
        console.error(e); alert("Bildirimler alınırken hata oluştu.");
      }
    }

    function getFiltered(){
      let list = all;
      if (filters.read !== ""){
        const want = filters.read === "1";
        list = list.filter(n => !!(n.is_read ?? n.read) === want);
      }
      if (filters.type){
        list = list.filter(n => (n.type||"").toLowerCase().includes(filters.type.toLowerCase()));
      }
      if (filters.q){
        list = list.filter(n => `${n.title||""} ${n.body||""}`.toLowerCase().includes(filters.q));
      }
      return list;
    }

    function render(){
      const listEl = document.getElementById("list");
      const empty = document.getElementById("empty");
      listEl.innerHTML = "";

      const data = getFiltered();
      if (!data.length){ empty.style.display=""; return; }
      empty.style.display="none";

      for (const n of data){
        const id = n.id ?? "-";
        const title = n.title || "(başlıksız)";
        const body = n.body || "";
        const isRead = !!(n.is_read ?? n.read);
        const pri = n.priority || "NORMAL";
        const type = n.type || "-";
        const ts = n.created_at || n.createdAt || "";

        const div = document.createElement("div");
        div.className = `ntf ${isRead? "" : "unread"}`;
        div.innerHTML = `
          <div class="row">
            <div class="title" style="font-weight:700;">${esc(title)}</div>
            <div class="actions">
              ${isRead ? "" : `<button class="btn" data-action="read" data-id="${id}">Okundu İşaretle</button>`}
              <button class="btn" data-action="open" data-id="${id}" ${n.source_log_id ? "" : "disabled"}>Kaynak Log</button>
            </div>
          </div>
          <div class="meta">
            <span class="pill pri-${esc(pri)}">Priority: ${esc(pri)}</span>
            <span class="pill">Type: ${esc(type)}</span>
            <span class="small muted">#${esc(id)}</span>
            <span class="small muted">${esc(fmt(ts))}</span>
          </div>
          ${body ? `<div class="desc">${esc(body)}</div>` : ""}
        `;
        listEl.appendChild(div);
      }
    }

    document.getElementById("list").addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");

      if (action === "read"){
        try{
          let res = await authFetch(`${API_BASE}/notifications/${encodeURIComponent(id)}/read`, { method:"PATCH" });
          if (res.status === 404 || res.status === 405) {
            res = await authFetch(`${API_BASE}/notifications/${encodeURIComponent(id)}/read`, { method:"PUT" });
          }
          if (!res.ok) throw new Error(await res.text() || "İşaretlenemedi");
          const item = all.find(x=>String(x.id)===String(id));
          if (item){ item.is_read = true; item.read = true; item.read_at = new Date().toISOString(); }
          render();
        }catch(err){ alert("Hata: " + (err.message || "okundu işaretleme")); }
      } else if (action === "open"){
        location.href = "logs-admin.html";
      }
    });

    document.getElementById("mark-all-btn").addEventListener("click", async ()=>{
      const unread = all.filter(n => !(n.is_read ?? n.read));
      if (!unread.length) return alert("Okunmamış bildirim yok.");
      if (!confirm(`${unread.length} bildirimi okundu yapmak istiyor musun?`)) return;

      try{
        for (const n of unread){
          try{
            let res = await authFetch(`${API_BASE}/notifications/${encodeURIComponent(n.id)}/read`, { method:"PATCH" });
            if (!res.ok) throw new Error("nok");
            n.is_read = true; n.read = true; n.read_at = new Date().toISOString();
          }catch(_){ }
        }
        render();
      }catch(e){ alert("Toplu işlemde hata oluştu."); }
    });

    loadNotifications();
  </script>
</body>
</html>
